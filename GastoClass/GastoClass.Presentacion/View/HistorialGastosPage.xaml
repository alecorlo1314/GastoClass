<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="GastoClass.Presentacion.View.HistorialGastosPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:editors="clr-namespace:Syncfusion.Maui.Inputs;assembly=Syncfusion.Maui.Inputs"
    xmlns:syncfusion="clr-namespace:Syncfusion.Maui.Toolkit.Popup;assembly=Syncfusion.Maui.Toolkit"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:vm="clr-namespace:GastoClass.Presentacion.ViewModel"
    Title="Historial de Gastos"
    Padding="48"
    BackgroundColor="{StaticResource FondoMenosBlanco}"
    Shell.BackgroundColor="{StaticResource FondoBlanco}"
    Shell.TitleColor="{StaticResource Gray950}">

    <!--  ESTATUS BAR  -->
    <ContentPage.Behaviors>
        <toolkit:StatusBarBehavior StatusBarColor="{StaticResource FondoBlanco}" StatusBarStyle="LightContent" />
    </ContentPage.Behaviors>

    <Grid RowDefinitions="Auto,*">

        <!--  OVERLAY DE CARGA  -->
        <ActivityIndicator
            Grid.RowSpan="2"
            BackgroundColor="Red"
            HeightRequest="40"
            HorizontalOptions="Center"
            IsRunning="{Binding IsBusy}"
            IsVisible="{Binding IsBusy}"
            VerticalOptions="Center"
            WidthRequest="40" />

        <!--
            ═══════════════════════════════════════════════════════════════════════════════════════════════
            POPUP DE ELIMINACION DE GASTOS (Usa EliminarGastoVM)
            ═══════════════════════════════════════════════════════════════════════════════════════════════
        -->
        <syncfusion:SfPopup
            x:Name="mipopupEliminacion"
            Grid.Row="1"
            x:DataType="vm:EliminarGastoViewModel"
            AnimationMode="None"
            BindingContext="{Binding EliminarGastoVM}"
            HeaderHeight="60"
            IsOpen="{Binding PopupVisible}"
            OverlayMode="Blur"
            ShowCloseButton="True"
            ShowFooter="True"
            StaysOpen="True"
            WidthRequest="700">
            <syncfusion:SfPopup.PopupStyle>
                <syncfusion:PopupStyle
                    BlurIntensity="Dark"
                    BlurRadius="10"
                    CloseButtonIcon="cancel_01.png"
                    CornerRadius="15"
                    FooterBackground="{StaticResource FondoBlanco}"
                    HasShadow="True"
                    HeaderFontFamily="PoppinsSemiBold"
                    HeaderFontSize="24"
                    PopupBackground="{StaticResource FondoBlanco}"
                    Stroke="Transparent" />
            </syncfusion:SfPopup.PopupStyle>

            <!--  ENCABEZADO DEL POPUP  -->
            <syncfusion:SfPopup.HeaderTemplate>
                <DataTemplate x:DataType="vm:EliminarGastoViewModel">
                    <StackLayout Padding="24">
                        <Label
                            FontFamily="PoppinsSemiBold"
                            FontSize="24"
                            Text="¿Estás seguro?"
                            TextColor="{StaticResource Gray950}" />
                    </StackLayout>
                </DataTemplate>
            </syncfusion:SfPopup.HeaderTemplate>

            <!--  CONTENIDO DEL POPUP  -->
            <syncfusion:SfPopup.ContentTemplate>
                <DataTemplate x:DataType="vm:EliminarGastoViewModel">
                    <Grid Padding="12">
                        <Label
                            FontFamily="PoppinsRegular"
                            FontSize="14"
                            HorizontalOptions="Start"
                            Text="{Binding MensajeConfirmacion}"
                            TextColor="{StaticResource Gray500}" />
                    </Grid>
                </DataTemplate>
            </syncfusion:SfPopup.ContentTemplate>

            <!--  FOOTER DEL POPUP  -->
            <syncfusion:SfPopup.FooterTemplate>
                <DataTemplate x:DataType="vm:EliminarGastoViewModel">
                    <StackLayout
                        Padding="24,0"
                        HorizontalOptions="End"
                        Orientation="Horizontal"
                        Spacing="16">
                        <Button
                            BackgroundColor="{StaticResource Gray100}"
                            Command="{Binding CancelarCommand}"
                            FontFamily="PoppinsSemiBold"
                            FontSize="18"
                            HeightRequest="48"
                            Text="Cancelar"
                            TextColor="{StaticResource Gray950}"
                            WidthRequest="140" />
                        <Button
                            BackgroundColor="{StaticResource Azul Principal}"
                            Command="{Binding EliminarCommand}"
                            FontFamily="PoppinsSemiBold"
                            FontSize="18"
                            HeightRequest="48"
                            IsEnabled="{Binding ProcesandoEliminacion, Converter={StaticResource InvertedBoolConverter}}"
                            Text="Eliminar"
                            TextColor="{StaticResource FondoBlanco}"
                            WidthRequest="140" />
                    </StackLayout>
                </DataTemplate>
            </syncfusion:SfPopup.FooterTemplate>
        </syncfusion:SfPopup>

        <!--
            ═══════════════════════════════════════════════════════════════════════════════════════════════
            POPUP DE EDICION DE GASTOS (Usa ActualizarGastoVM)
            ═══════════════════════════════════════════════════════════════════════════════════════════════
        -->
        <syncfusion:SfPopup
            x:Name="mipopup"
            Grid.Row="1"
            x:DataType="vm:ActualizarGastoViewModel"
            AnimationMode="None"
            BindingContext="{Binding ActualizarGastoVM}"
            HeaderHeight="97"
            HeightRequest="600"
            IsOpen="{Binding PopupVisible}"
            OverlayMode="Blur"
            ShowCloseButton="True"
            ShowFooter="True"
            StaysOpen="True"
            WidthRequest="500">
            <syncfusion:SfPopup.PopupStyle>
                <syncfusion:PopupStyle
                    BlurIntensity="Dark"
                    BlurRadius="10"
                    CloseButtonIcon="cancel_01.png"
                    CornerRadius="0"
                    FooterBackground="{StaticResource FondoBlanco}"
                    HasShadow="True"
                    HeaderFontFamily="PoppinsSemiBold"
                    HeaderFontSize="24"
                    PopupBackground="{StaticResource FondoBlanco}"
                    Stroke="Transparent" />
            </syncfusion:SfPopup.PopupStyle>

            <!--  ENCABEZADO DEL POPUP  -->
            <syncfusion:SfPopup.HeaderTemplate>
                <DataTemplate x:DataType="vm:ActualizarGastoViewModel">
                    <StackLayout Padding="24">
                        <Label
                            FontFamily="PoppinsSemiBold"
                            FontSize="24"
                            Text="Editar Gasto"
                            TextColor="{StaticResource Gray950}" />
                        <Label
                            FontFamily="PoppinsRegular"
                            FontSize="14"
                            Text="Actualiza los detalles de tu gasto"
                            TextColor="{StaticResource Gray500}" />
                    </StackLayout>
                </DataTemplate>
            </syncfusion:SfPopup.HeaderTemplate>

            <!--  CONTENIDO DEL POPUP  -->
            <syncfusion:SfPopup.ContentTemplate>
                <DataTemplate x:DataType="vm:ActualizarGastoViewModel">
                    <ScrollView Padding="24">
                        <VerticalStackLayout Spacing="16">

                            <!--  MONTO  -->
                            <VerticalStackLayout Spacing="8">
                                <Label
                                    FontFamily="PoppinsMedium"
                                    FontSize="14"
                                    Text="Monto"
                                    TextColor="#333" />
                                <Border
                                    BackgroundColor="{StaticResource FondoMenosBlanco}"
                                    Stroke="{StaticResource ColorStrokeFomulariosEntrada}"
                                    StrokeShape="RoundRectangle 4">
                                    <Entry
                                        FontFamily="PoppinsRegular"
                                        FontSize="16"
                                        Keyboard="Numeric"
                                        Placeholder="$0.00"
                                        Text="{Binding MontoSeleccionado}"
                                        TextColor="{StaticResource Gray950}" />
                                </Border>
                                <!--  Mensaje de error  -->
                                <Label
                                    Margin="0,5,0,0"
                                    FontSize="12"
                                    IsVisible="{Binding MostrarErrorMonto}"
                                    Text="{Binding MensajeErrorMonto}"
                                    TextColor="Red" />
                            </VerticalStackLayout>

                            <!--  DESCRIPCION  -->
                            <VerticalStackLayout Spacing="8">
                                <Label
                                    FontFamily="PoppinsMedium"
                                    FontSize="14"
                                    Text="Descripción"
                                    TextColor="#333" />
                                <Border
                                    BackgroundColor="{StaticResource FondoMenosBlanco}"
                                    Stroke="{StaticResource ColorStrokeFomulariosEntrada}"
                                    StrokeShape="RoundRectangle 4">
                                    <Entry
                                        FontFamily="PoppinsRegular"
                                        FontSize="16"
                                        Placeholder="Ej: Almuerzo en restaurante"
                                        Text="{Binding DescripcionSeleccionada}"
                                        TextColor="{StaticResource Gray950}" />
                                </Border>
                                <!--  Mensaje de error  -->
                                <Label
                                    Margin="0,5,0,0"
                                    FontSize="12"
                                    IsVisible="{Binding MostrarErrorDescripcion}"
                                    Text="{Binding MensajeErrorDescripcion}"
                                    TextColor="Red" />
                            </VerticalStackLayout>

                            <!--  FECHA  -->
                            <VerticalStackLayout Spacing="8">
                                <Label
                                    FontFamily="PoppinsMedium"
                                    FontSize="14"
                                    Text="Fecha"
                                    TextColor="#333" />
                                <Border
                                    BackgroundColor="{StaticResource FondoMenosBlanco}"
                                    Stroke="{StaticResource ColorStrokeFomulariosEntrada}"
                                    StrokeShape="RoundRectangle 4">
                                    <DatePicker
                                        Margin="8,0"
                                        Date="{Binding FechaSeleccionada}"
                                        FontFamily="PoppinsRegular"
                                        FontSize="16"
                                        Format="dd/MM/yyyy"
                                        TextColor="{StaticResource Gray950}" />
                                </Border>
                                <!--  Mensaje de error  -->
                                <Label
                                    Margin="0,5,0,0"
                                    FontSize="12"
                                    IsVisible="{Binding MostrarErrorFecha}"
                                    Text="{Binding MensajeErrorFecha}"
                                    TextColor="Red" />
                            </VerticalStackLayout>

                            <!--  COMERCIO  -->
                            <VerticalStackLayout Spacing="8">
                                <Label
                                    FontFamily="PoppinsMedium"
                                    FontSize="14"
                                    Text="Comercio"
                                    TextColor="#333" />
                                <Border
                                    BackgroundColor="{StaticResource FondoMenosBlanco}"
                                    Stroke="{StaticResource ColorStrokeFomulariosEntrada}"
                                    StrokeShape="RoundRectangle 4">
                                    <Entry
                                        FontFamily="PoppinsRegular"
                                        FontSize="16"
                                        Placeholder="Ej: McDonald's"
                                        Text="{Binding ComercioSeleccionado}"
                                        TextColor="{StaticResource Gray950}" />
                                </Border>
                                <!--  Mensaje de error  -->
                                <Label
                                    Margin="0,5,0,0"
                                    FontSize="12"
                                    IsVisible="{Binding MostrarErrorComercio}"
                                    Text="{Binding MensajeErrorComercio}"
                                    TextColor="Red" />
                            </VerticalStackLayout>

                            <!--  CATEGORIA  -->
                            <VerticalStackLayout Spacing="8">
                                <Label
                                    FontFamily="PoppinsMedium"
                                    FontSize="14"
                                    Text="Categoría"
                                    TextColor="#333" />
                                <Border
                                    BackgroundColor="{StaticResource FondoMenosBlanco}"
                                    Stroke="{StaticResource ColorStrokeFomulariosEntrada}"
                                    StrokeShape="RoundRectangle 4">
                                    <editors:SfComboBox
                                        ClearButtonIconColor="{StaticResource Gray600}"
                                        DisplayMemberPath="CategoriaPrincipal"
                                        DropDownIconColor="{StaticResource Gray600}"
                                        FontFamily="PoppinsRegular"
                                        FontSize="16"
                                        HeightRequest="45"
                                        IsEditable="False"
                                        ItemsSource="{Binding ListaCategoriasPredichas}"
                                        Placeholder="Categoría sugerida"
                                        PlaceholderColor="{StaticResource Gray500}"
                                        SelectedItem="{Binding CategoriaPredicha}"
                                        TextColor="{StaticResource Gray950}"
                                        TextMemberPath="CategoriaPrincipal" />
                                </Border>
                                <!--  Mensaje de error  -->
                                <Label
                                    Margin="0,5,0,0"
                                    FontSize="12"
                                    IsVisible="{Binding MostrarErrorCategoria}"
                                    Text="{Binding MensajeErrorCategoria}"
                                    TextColor="Red" />
                            </VerticalStackLayout>

                        </VerticalStackLayout>
                    </ScrollView>
                </DataTemplate>
            </syncfusion:SfPopup.ContentTemplate>

            <!--  FOOTER DEL POPUP  -->
            <syncfusion:SfPopup.FooterTemplate>
                <DataTemplate x:DataType="vm:ActualizarGastoViewModel">
                    <StackLayout
                        Padding="24,0"
                        HorizontalOptions="End"
                        Orientation="Horizontal"
                        Spacing="16">
                        <Button
                            BackgroundColor="{StaticResource Gray100}"
                            Command="{Binding CancelarCommand}"
                            FontFamily="PoppinsSemiBold"
                            FontSize="18"
                            HeightRequest="48"
                            Text="Cancelar"
                            TextColor="{StaticResource Gray950}"
                            WidthRequest="140" />
                        <Button
                            BackgroundColor="{StaticResource Azul Principal}"
                            Command="{Binding ActualizarGastoCommand}"
                            FontFamily="PoppinsSemiBold"
                            FontSize="18"
                            HeightRequest="48"
                            Text="Guardar"
                            TextColor="{StaticResource FondoBlanco}"
                            WidthRequest="140" />
                    </StackLayout>
                </DataTemplate>
            </syncfusion:SfPopup.FooterTemplate>
        </syncfusion:SfPopup>

        <!--
            ═══════════════════════════════════════════════════════════════════════════════════════════════
            ENCABEZADO Y BARRA DE BUSQUEDA (Usa HistorialGastosVM)
            ═══════════════════════════════════════════════════════════════════════════════════════════════
        -->
        <StackLayout Grid.Row="0">
            <StackLayout Margin="0,0,0,32" Spacing="16">
                <Label
                    FontFamily="PoppinsRegular"
                    FontSize="18"
                    HorizontalOptions="Start"
                    Text="Aquí puedes ver, filtrar y gestionar todos tus gastos pasados."
                    TextColor="{StaticResource Gray500}" />
                <Border
                    BackgroundColor="{StaticResource FondoBlanco}"
                    HeightRequest="48"
                    HorizontalOptions="Start"
                    Stroke="Transparent"
                    StrokeShape="RoundRectangle 15"
                    WidthRequest="600">
                    <HorizontalStackLayout>
                        <Image
                            Margin="12,0"
                            HeightRequest="24"
                            Source="search.png"
                            VerticalOptions="Center" />
                        <Entry
                            BackgroundColor="Transparent"
                            ClearButtonVisibility="WhileEditing"
                            FontFamily="PoppinsRegular"
                            FontSize="16"
                            Placeholder="Buscar gasto..."
                            PlaceholderColor="{StaticResource Gray500}"
                            Text="{Binding TextoBusqueda}"
                            TextColor="{StaticResource Gray900}"
                            VerticalOptions="Center"
                            WidthRequest="550" />
                    </HorizontalStackLayout>
                </Border>
            </StackLayout>
        </StackLayout>

        <!--
            ═══════════════════════════════════════════════════════════════════════════════════════════════
            LISTA DE GASTOS (Usa HistorialGastosVM)
            ═══════════════════════════════════════════════════════════════════════════════════════════════
        -->
        <Border
            Grid.Row="1"
            Padding="16"
            BackgroundColor="{StaticResource FondoBlanco}"
            Stroke="Transparent"
            StrokeShape="RoundRectangle 15">
            <Grid RowDefinitions="Auto,Auto,*" RowSpacing="16">

                <!--  TITULOS DEL ENCABEZADO  -->
                <Grid ColumnDefinitions="2*,1*,2*,1*,1*,2*,1*">
                    <Label
                        Grid.Column="0"
                        FontFamily="PoppinsMedium"
                        FontSize="14"
                        HorizontalOptions="Start"
                        Text="Descripción"
                        TextColor="{StaticResource Gray500}" />
                    <Label
                        Grid.Column="1"
                        FontFamily="PoppinsMedium"
                        FontSize="14"
                        HorizontalOptions="Start"
                        Text="Transacción ID"
                        TextColor="{StaticResource Gray500}" />
                    <Label
                        Grid.Column="2"
                        FontFamily="PoppinsMedium"
                        FontSize="14"
                        HorizontalOptions="Start"
                        Text="Categoría"
                        TextColor="{StaticResource Gray500}" />
                    <Label
                        Grid.Column="3"
                        FontFamily="PoppinsMedium"
                        FontSize="14"
                        HorizontalOptions="Start"
                        Text="Tarjeta"
                        TextColor="{StaticResource Gray500}" />
                    <Label
                        Grid.Column="4"
                        FontFamily="PoppinsMedium"
                        FontSize="14"
                        HorizontalOptions="Start"
                        Text="Fecha"
                        TextColor="{StaticResource Gray500}" />
                    <Label
                        Grid.Column="5"
                        FontFamily="PoppinsMedium"
                        FontSize="14"
                        HorizontalOptions="Start"
                        Text="Monto"
                        TextColor="{StaticResource Gray500}" />
                    <Label
                        Grid.Column="6"
                        FontFamily="PoppinsMedium"
                        FontSize="14"
                        HorizontalOptions="Start"
                        Text="Acción"
                        TextColor="{StaticResource Gray500}" />
                </Grid>

                <!--  LINEA SEPARADORA  -->
                <Border Grid.Row="1" Stroke="{StaticResource Gray100}" />

                <!--  LISTA DE MOVIMIENTOS  -->
                <CollectionView Grid.Row="2" ItemsSource="{Binding ListaGastosFiltrados}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Grid ColumnDefinitions="2*,1*,2*,1*,1*,2*,1*" HeightRequest="48">
                                <Label
                                    Grid.Column="0"
                                    FontFamily="PoppinsRegular"
                                    FontSize="16"
                                    HorizontalOptions="Start"
                                    Text="{Binding Descripcion}"
                                    TextColor="{StaticResource Gray900}"
                                    VerticalOptions="Center" />
                                <Label
                                    Grid.Column="1"
                                    FontFamily="PoppinsRegular"
                                    FontSize="16"
                                    HorizontalOptions="Start"
                                    Text="{Binding Id, StringFormat='#{0:N0}'}"
                                    TextColor="{StaticResource Gray900}"
                                    VerticalOptions="Center" />
                                <Label
                                    Grid.Column="2"
                                    FontFamily="PoppinsRegular"
                                    FontSize="16"
                                    HorizontalOptions="Start"
                                    Text="{Binding Categoria}"
                                    TextColor="{StaticResource Gray900}"
                                    VerticalOptions="Center" />
                                <Label
                                    Grid.Column="3"
                                    FontFamily="PoppinsRegular"
                                    FontSize="16"
                                    HorizontalOptions="Start"
                                    Text="{Binding TarjetaId}"
                                    TextColor="{StaticResource Gray900}"
                                    VerticalOptions="Center" />
                                <Label
                                    Grid.Column="4"
                                    FontFamily="PoppinsRegular"
                                    FontSize="16"
                                    HorizontalOptions="Start"
                                    Text="{Binding Fecha, StringFormat='{0:dd.MM.yy}'}"
                                    TextColor="{StaticResource Gray900}"
                                    VerticalOptions="Center" />
                                <Label
                                    Grid.Column="5"
                                    FontFamily="PoppinsRegular"
                                    FontSize="16"
                                    HorizontalOptions="Start"
                                    Text="{Binding Monto, StringFormat='- ₡{0:N2}'}"
                                    TextColor="#FE5C73"
                                    VerticalOptions="Center" />
                                <Border
                                    Grid.Column="6"
                                    Padding="0"
                                    BackgroundColor="{StaticResource FondoMenosBlanco}"
                                    HeightRequest="42"
                                    Stroke="{StaticResource Gray400}"
                                    StrokeShape="RoundRectangle 15"
                                    StrokeThickness="0.5"
                                    VerticalOptions="Center"
                                    WidthRequest="96">
                                    <Grid ColumnDefinitions="*,*">
                                        <!--  Botón Editar  -->
                                        <ImageButton
                                            Aspect="AspectFit"
                                            BackgroundColor="Transparent"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:HistorialGastosViewModel}}, Path=AbrirEdicionCommand}"
                                            CommandParameter="{Binding .}"
                                            Source="pencil_edit_02.png" />
                                        <!--  Botón Eliminar  -->
                                        <ImageButton
                                            Grid.Column="1"
                                            Aspect="AspectFit"
                                            BackgroundColor="Transparent"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:HistorialGastosViewModel}}, Path=AbrirEliminacionCommand}"
                                            CommandParameter="{Binding .}"
                                            Source="delete_02.png" />
                                    </Grid>
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>

                    <!--  VISTA VACIA  -->
                    <CollectionView.EmptyView>
                        <ContentView>
                            <StackLayout HorizontalOptions="Center" VerticalOptions="Center">
                                <Label
                                    FontFamily="PoppinsSemiBold"
                                    FontSize="32"
                                    HorizontalOptions="Fill"
                                    HorizontalTextAlignment="Center"
                                    Text="No hay gastos"
                                    TextColor="{StaticResource Gray950}" />
                                <Label
                                    FontFamily="PoppinsRegular"
                                    FontSize="16"
                                    HorizontalOptions="Fill"
                                    HorizontalTextAlignment="Center"
                                    Text="Trata Agregar datos o busca uno diferente!"
                                    TextColor="{StaticResource Gray500}" />
                            </StackLayout>
                        </ContentView>
                    </CollectionView.EmptyView>
                </CollectionView>
            </Grid>
        </Border>
    </Grid>
</ContentPage>